From 775502c3c62d8812822fc39562d9949569e0c3a8 Mon Sep 17 00:00:00 2001
From: NN <nn@gmail.com>
Date: Sun, 2 Apr 2023 00:11:01 -0400
Subject: [PATCH] bpi-r3

---
 config/Config-images.in                       |  2 +-
 include/target.mk                             |  2 +-
 .../hack-6.1/400-fixup-ubi-warning.patch     | 13 ++++++++++++

diff --git a/config/Config-images.in b/config/Config-images.in
index 8c4616f37c..a2c9be7d22 100644
--- a/config/Config-images.in
+++ b/config/Config-images.in
@@ -296,7 +296,7 @@ menu "Target Images"
 	config TARGET_ROOTFS_PARTSIZE
 		int "Root filesystem partition size (in MiB)"
 		depends on USES_ROOTFS_PART || TARGET_ROOTFS_EXT4FS
-		default 104
+		default 256
 		help
 		  Select the root filesystem partition size.
 
diff --git a/include/target.mk b/include/target.mk
index 992f955344..aedf348ab4 100644
--- a/include/target.mk
+++ b/include/target.mk
@@ -25,7 +25,7 @@ DEFAULT_PACKAGES:=\
 	uci \
 	uclient-fetch \
 	urandom-seed \
-	urngd
+	urngd bridger luci-app-openvpn openvpn-openssl openvpn-easy-rsa collectd-mod-conntrack collectd-mod-cpufreq collectd-mod-irq collectd-mod-thermal luci-app-ksmbd luci-proto-wireguard bash blkid block-mount blockd btrfs-progs ca-certificates cgi-io collectd collectd-mod-cpu collectd-mod-interface collectd-mod-iwinfo collectd-mod-load collectd-mod-memory collectd-mod-network collectd-mod-rrdtool containerd -dnsmasq dnsmasq-full docker docker-compose dockerd fdisk fstools fwtool getrandom iw iwinfo jansson jshn jsonfilter kernel kmod-asn1-decoder kmod-asn1-encoder kmod-br-netfilter kmod-crypto-acompress kmod-crypto-aead kmod-crypto-authenc kmod-crypto-cbc kmod-crypto-ccm kmod-crypto-cmac kmod-crypto-crc32c kmod-crypto-ctr kmod-crypto-deflate kmod-crypto-des kmod-crypto-echainiv kmod-crypto-gcm kmod-crypto-gf128 kmod-crypto-ghash kmod-crypto-hash kmod-crypto-hmac kmod-crypto-manager kmod-crypto-md5 kmod-crypto-michael-mic kmod-crypto-null kmod-crypto-rng kmod-crypto-seqiv kmod-crypto-sha1 kmod-crypto-sha256 kmod-dax kmod-dm kmod-dummy kmod-fs-autofs4 kmod-fs-btrfs kmod-fs-exfat kmod-fs-ext4 kmod-fs-ntfs3 kmod-fuse kmod-hwmon-core kmod-ikconfig kmod-ipsec kmod-ipt-conntrack kmod-ipt-core kmod-ipt-extra kmod-ipt-nat kmod-ipt-nat6 kmod-ipt-physdev kmod-iptunnel kmod-keys-encrypted kmod-keys-trusted kmod-lib-crc-ccitt kmod-lib-crc16 kmod-lib-crc32c kmod-lib-lzo kmod-lib-raid6 kmod-lib-textsearch kmod-lib-xor kmod-lib-zlib-deflate kmod-lib-zlib-inflate kmod-lib-zstd kmod-libphy kmod-macvlan kmod-nf-conntrack kmod-nf-conntrack-netlink kmod-nf-conntrack6 kmod-nf-flow kmod-nf-ipt kmod-nf-ipt6 kmod-nf-ipvs kmod-nf-log kmod-nf-log6 kmod-nf-nat kmod-nf-nat6 kmod-nf-nathelper kmod-nf-nathelper-extra kmod-nf-reject kmod-nf-reject6 kmod-nfnetlink kmod-nft-compat kmod-nft-core kmod-nft-fib kmod-nft-nat kmod-nft-offload kmod-nls-base kmod-oid-registry kmod-ppp kmod-pppoe kmod-pppox kmod-random-core kmod-scsi-core kmod-slhc kmod-thermal kmod-tpm kmod-udptunnel4 kmod-udptunnel6 kmod-usb-core kmod-usb-storage kmod-usb-storage-extras kmod-usb-storage-uas kmod-usb-xhci-hcd kmod-usb3 kmod-veth kmod-vxlan libattr libblkid libblobmsg-json libcap libcomerr libdevmapper libevdev libext2fs libfdisk libgmp libiptext libiptext-nft libiptext6 libiwinfo libiwinfo-data libjson-c libjson-script libltdl liblua liblucihttp liblucihttp-lua liblucihttp-ucode liblzo libmbedtls libmnl libmount libncurses libnetfilter-conntrack libnettle libnfnetlink libnftnl libnl-tiny libopenssl libparted libreadline librrd1 libseccomp libsmartcols libss libubox libubus libubus-lua libuci libuclient libucode libudev-zero libusb-1.0 libustream-mbedtls libuuid libuv libwebsockets-full libxtables logd lsblk lua luci luci-app-dockerman luci-app-firewall luci-app-opkg luci-app-statistics luci-app-ttyd luci-base luci-compat luci-lib-base luci-lib-docker luci-lib-ip luci-lib-jsonc luci-lib-nixio luci-light luci-lua-runtime luci-mod-admin-full luci-mod-network luci-mod-status luci-mod-system luci-proto-ipv6 luci-proto-ppp luci-theme-bootstrap mount-utils mtd nftables-json ntfs-3g odhcp6c odhcpd-ipv6only openwrt-keyring parted ppp procd procd-seccomp procd-ujail rpcd rpcd-mod-file rpcd-mod-iwinfo rpcd-mod-luci rpcd-mod-rrdns rpcd-mod-ucode rrdtool1 runc smartmontools terminfo tini ttyd ubi-utils ubox ubus ubusd ucode ucode-mod-fs ucode-mod-html ucode-mod-lua ucode-mod-math ucode-mod-ubus ucode-mod-uci uhttpd uhttpd-mod-ubus usbutils usign vsftpd wireless-regdb xtables-nft btop htop ucert luci-app-commands luci-app-diskman luci-app-pbr luci-app-adblock adb collectd-mod-sensors pciutils smartmontools-drivedb kmod-ata-ahci kmod-ata-core kmod-nvme kmod-usb-net-rndis resolveip wget-ssl ip-full ethtool iperf3-ssl tcpdump-mini luci-app-sqm luci-app-nlbwmon kmod-mtd-rw atop ccrypt certtool cryptsetup cryptsetup-ssh kmod-crypto-user kmod-hwmon-gpiofan kmod-hwmon-pwmfan kmod-i2c-core kmod-mt76-usb kmod-mt76x02-common kmod-mt76x02-usb kmod-mt76x2-common kmod-mt76x2u kmod-mt7921-common kmod-mt7921-firmware kmod-mt7921e kmod-mt7921u kmod-mt792x-common kmod-mt792x-usb kmod-usb-net-cdc-ncm kmod-usb-net-rtl8152 kmod-usb-printer libaio libgnutls libpopt libssh lvm2 arp-scan arp-scan-database kmod-crypto-arc4 kmod-crypto-crc32 kmod-cryptodev kmod-fs-f2fs kmod-fs-squashfs kmod-fs-vfat kmod-gre kmod-l2tp kmod-mppe kmod-netatop kmod-nls-cp437 kmod-pppol2tp kmod-pptp kmod-usb-net-ipheth kmod-usb-net-qmi-wwan kmod-usb-uhci kmod-usb-wdm netatop ppp-mod-pppol2tp ppp-mod-pptp xl2tpd
 
 ifneq ($(CONFIG_SELINUX),)
 DEFAULT_PACKAGES+=busybox-selinux procd-selinux
diff --git a/target/linux/generic/hack-6.1/400-fixup-ubi-warning.patch b/target/linux/generic/hack-6.1/400-fixup-ubi-warning.patch
new file mode 100644
index 0000000000..2e6ff2dc22
--- /dev/null
+++ b/target/linux/generic/hack-6.1/400-fixup-ubi-warning.patch
@@ -0,0 +1,13 @@
+--- a/drivers/mtd/mtdblock.c
++++ b/drivers/mtd/mtdblock.c
+@@ -257,10 +257,6 @@ static int mtdblock_open(struct mtd_blkt
+ 		return 0;
+ 	}
+ 
+-	if (mtd_type_is_nand(mbd->mtd))
+-		pr_warn("%s: MTD device '%s' is NAND, please consider using UBI block devices instead.\n",
+-			mbd->tr->name, mbd->mtd->name);
+-
+ 	/* OK, it's not open. Create cache info for it */
+ 	mtdblk->count = 1;
+ 	mutex_init(&mtdblk->cache_mutex);
diff --git a/target/linux/mediatek/Makefile b/target/linux/mediatek/Makefile
index f73f2daef6..279c167b83 100644
--- a/target/linux/mediatek/Makefile
+++ b/target/linux/mediatek/Makefile
@@ -8,8 +8,7 @@ BOARDNAME:=MediaTek Ralink ARM
 SUBTARGETS:=mt7622 mt7623 mt7629 filogic
 FEATURES:=dt-overlay emmc fpu gpio nand pci pcie rootfs-part separate_ramdisk squashfs usb

-KERNEL_PATCHVER:=5.15
-KERNEL_TESTING_PATCHVER:=6.1
+KERNEL_PATCHVER:=6.1

 include $(INCLUDE_DIR)/target.mk
 DEFAULT_PACKAGES += \
diff --git a/target/linux/mediatek/filogic/base-files/etc/board.d/02_network b/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
index 4013c149f1..6d8f66c388 100644
--- a/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
+++ b/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
@@ -19,7 +19,7 @@ mediatek_setup_interfaces()
 		ucidef_set_interfaces_lan_wan "lan1 lan2 lan3 lan4 lan5" eth1
 		;;
 	bananapi,bpi-r3)
-		ucidef_set_interfaces_lan_wan "lan1 lan2 lan3 lan4 sfp2" "eth1 wan"
+		ucidef_set_interfaces_lan_wan "eth1 lan1 lan2 lan3 lan4 sfp2" wan
 		;;
 	cetron,ct3003|\
 	confiabits,mt7981|\
diff --git a/package/firmware/wireless-regdb/patches/600-custom.patch b/package/firmware/wireless-regdb/patches/600-custom.patch
new file mode 100644
index 0000000000..46590f4d28
--- /dev/null
+++ b/package/firmware/wireless-regdb/patches/600-custom.patch
@@ -0,0 +1,30 @@
+--- a/db.txt
++++ b/db.txt
+@@ -353,8 +353,8 @@ country CL: DFS-JP
+ # https://wap.miit.gov.cn/cms_files/filemanager/1226211233/attach/20219/d125301b13454551b698ff5afa49ca28.pdf
+ # Note: The transmit power for 5150-5350MHz bands can be raised by 3dBm when TPC is implemented
+ country CN: DFS-FCC
+-	(2400 - 2483.5 @ 40), (20)
+-	(5150 - 5350 @ 80), (20), DFS, AUTO-BW
++	(2400 - 2483.5 @ 40), (30)
++	(5150 - 5350 @ 160), (30)
+ 	(5725 - 5850 @ 80), (33)
+ 	# 60 GHz band channels 1,4: 28dBm, channels 2,3: 44dBm
+ 	# ref: http://www.miit.gov.cn/n11293472/n11505629/n11506593/n11960250/n11960606/n11960700/n12330791.files/n12330790.pdf
+@@ -1626,14 +1626,12 @@ country US: DFS-FCC
+ 	(920-928 @ 8), (30)
+ 	(2400 - 2472 @ 40), (30)
+ 	# 5.15 ~ 5.25 GHz: 30 dBm for master mode, 23 dBm for clients
+-	(5150 - 5250 @ 80), (23), AUTO-BW
+-	(5250 - 5350 @ 80), (24), DFS, AUTO-BW
++	(5150 - 5350 @ 160), (30)
+ 	# This range ends at 5725 MHz, but channel 144 extends to 5730 MHz.
+ 	# Since 5725 ~ 5730 MHz belongs to the next range which has looser
+ 	# requirements, we can extend the range by 5 MHz to make the kernel
+ 	# happy and be able to use channel 144.
+-	(5470 - 5730 @ 160), (24), DFS
+-	(5730 - 5850 @ 80), (30), AUTO-BW
++	(5470 - 5850 @ 160), (30)
+ 	# https://www.federalregister.gov/documents/2021/05/03/2021-08802/use-of-the-5850-5925-ghz-band
+ 	# max. 33 dBm AP @ 20MHz, 36 dBm AP @ 40Mhz+, 6 dB less for clients
+ 	(5850 - 5895 @ 40), (27), NO-OUTDOOR, AUTO-BW, NO-IR
-- 
2.39.2

